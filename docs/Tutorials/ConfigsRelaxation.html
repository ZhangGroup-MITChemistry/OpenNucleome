<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorials: Configuration Relaxation &mdash; openNucleome 1.3.0 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/jupyter-sphinx.css" type="text/css" />
      <link rel="stylesheet" href="../_static/thebelab.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/logo.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tutorials: Configuration Selection" href="ConfigsSelection.html" />
    <link rel="prev" title="Tutorials: Configuration Generation" href="ConfigsGeneration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            openNucleome
              <img src="../_static/website_pic.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.3.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../GettingStarted/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GettingStarted/Introduction.html">Introduction</a></li>
</ul>
<p class="caption"><span class="caption-text">OpenNucleome:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../OpenNucleome.html">openNucleome</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="LangevinSimulation.html">Sphere Model: Langevin Dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="BrownianSimulation.html">Sphere Model: Brownian Dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="NuclearDeformation.html">Nuclear Deformation Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConfigsGeneration.html">Tutorials: Configuration Generation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorials: Configuration Relaxation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Import-the-necessary-packages">Import the necessary packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Important-parameters">Important parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Initialize-the-system">Initialize the system</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Add-the-force-field">Add the force field</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Perform-the-simulation">Perform the simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Post-process-the-output-files">Post-process the output files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ConfigsSelection.html">Tutorials: Configuration Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="ComputeContactProb.html">Tutorials: Contact Probability Computation</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChrChrOptimization.html">Tutorials: Chromosome Chromosome Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChrNLOptimization.html">Tutorials: Chromosome Nuclear Landmarks Optimization</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">openNucleome</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tutorials: Configuration Relaxation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Tutorials/ConfigsRelaxation.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Tutorials:-Configuration-Relaxation">
<h1>Tutorials: Configuration Relaxation<a class="headerlink" href="#Tutorials:-Configuration-Relaxation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Import-the-necessary-packages">
<h2>Import the necessary packages<a class="headerlink" href="#Import-the-necessary-packages" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">parmed</span> <span class="k">as</span> <span class="nn">pmd</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">platform</span>
<span class="kn">import</span> <span class="nn">mdtraj</span> <span class="k">as</span> <span class="nn">md</span>
<span class="kn">import</span> <span class="nn">simtk.openmm.app</span> <span class="k">as</span> <span class="nn">mmapp</span>
<span class="kn">import</span> <span class="nn">mdtraj.reporters</span>
<span class="kn">import</span> <span class="nn">simtk.unit</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">openNucleome</span> <span class="kn">import</span> <span class="n">OpenNucleome</span>
<span class="kn">from</span> <span class="nn">openNucleome.utils</span> <span class="kn">import</span> <span class="n">coor_transformation</span><span class="p">,</span> <span class="n">final_frame</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Important-parameters">
<h2>Important parameters<a class="headerlink" href="#Important-parameters" title="Permalink to this headline">¶</a></h2>
<p>We defined the important parameters in the next block. First, we set the transition probability between dP particles and P particles as 0.2, and the transition frequency as 4000. When creating the system, we set type 6, 7 as the dP and P particles, respectively, so we kept using 6, 7 here. In this example, we ran a simulation with total length of 100,000 steps, and output one configuration and the energy every 2000 steps.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prob_P_dP</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="c1"># Transition probability from P to dP</span>
<span class="n">prob_dP_P</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="c1"># Transition probability from dP to P</span>
<span class="n">transition_freq</span> <span class="o">=</span> <span class="mi">4000</span>
<span class="n">sampling_freq</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">dP_type</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">P_type</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">total_steps</span> <span class="o">=</span> <span class="mi">100000</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Initialize-the-system">
<h2>Initialize the system<a class="headerlink" href="#Initialize-the-system" title="Permalink to this headline">¶</a></h2>
<p>We first set up an example “model” of class “OpenNucleome” with the conserved temperature, damping coefficient, timestep, and the mass scale. In this folder, we also included the initial configuration “human.pdb” used for the simulation and created a system according to the initial configuration.</p>
<p>In this example, we freezed all the lamina beads, and would not consider the dynamics of the membrane, and that is why we set “False” (off) for membrane dynamics. Consequently, there was also no need to set the bond between lamina beads, so we set “None” for the variable “lam_bond”.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">OpenNucleome</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># 1.0: temperature (LJ reduced unit);</span>
                                           <span class="c1"># 0.1: damping coefficient (LJ reduced unit);</span>
                                           <span class="c1"># 0.005: timestep (LJ reduced unit);</span>
                                           <span class="c1"># 1.0: mass_scale</span>

<span class="n">PDB_file</span> <span class="o">=</span> <span class="s2">&quot;../configs_generation/init_config_pool/human_1.pdb&quot;</span> <span class="c1">#The initial configuration</span>

<span class="c1"># Generate new elements and construct topology as well</span>
<span class="c1"># flag_membrane: True for including lamina dynamics, False for excluding lamina dynamics;</span>
<span class="c1"># lam_bond: A file contains the lamina bond when membrane_dynamics is on.</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">create_system</span><span class="p">(</span><span class="n">PDB_file</span><span class="p">,</span> <span class="n">flag_membrane</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">lam_bond</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Add-the-force-field">
<h2>Add the force field<a class="headerlink" href="#Add-the-force-field" title="Permalink to this headline">¶</a></h2>
<p>In this example, we loaded default settings for the interactions between chromosomes and chromosomes, and chromosomes and nuclear landmarks. All the types of potential can be found in “Section: Energy function of the whole nucleus model” in Supporting Information. According to the order of added potential, the index of speckle-speckle potential is 6, and this index is needed when transiting the speckle particle between type 6 and type 7.</p>
<p>Because during the simulations, we would transit the dP speckle and P speckle particles, here, we logged the start index and end index of speckle particle, and computed the number of speckle particles.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add the default force field</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_default_settings</span><span class="p">()</span>

<span class="n">index_spec_spec_potential</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1">#The 6-th potential is speckle-speckle interaction in the default settings</span>
<span class="n">start_spec_index</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">N_chr_nuc</span><span class="o">+</span><span class="mi">1</span>
<span class="n">end_spec_index</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">N_chr_nuc_spec</span><span class="o">+</span><span class="mi">1</span>
<span class="n">N_spec</span> <span class="o">=</span> <span class="n">end_spec_index</span><span class="o">-</span><span class="n">start_spec_index</span> <span class="c1">#Currently, the number of speckle is 1600.</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Perform-the-simulation">
<h2>Perform the simulation<a class="headerlink" href="#Perform-the-simulation" title="Permalink to this headline">¶</a></h2>
<p>We first created the simulation with a specific Platform, and here, we used “CUDA” but users can also use “CPU”, “Reference”, and “OpenCL” according to their hardware. Before the simulation, we minimized the energy to make the system much more reasonable and stable. After randomly setting velocity, we started our simulation with a total length of 100,000 steps and output the configuration and energy every 2000 steps, and change the speckle types every 4000 steps as we mentioned in the previous
blocks.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#model.save_system(&quot;model_before_simulation_0.xml&quot;)</span>

<span class="n">simulation</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create_simulation</span><span class="p">(</span><span class="n">platform_type</span> <span class="o">=</span> <span class="s2">&quot;CUDA&quot;</span><span class="p">)</span> <span class="c1"># Users can also use CPU, Reference, OpenCL.</span>
<span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">chr_positions</span><span class="p">)</span>

<span class="n">simulation</span><span class="o">.</span><span class="n">minimizeEnergy</span><span class="p">()</span>

<span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mdtraj</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">DCDReporter</span><span class="p">(</span><span class="s1">&#39;results/step_100000.dcd&#39;</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">setVelocity</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">chr_system</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">velocs</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">chr_system</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)),</span>
                        <span class="n">u</span><span class="o">.</span><span class="n">meter</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">meter</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">setVelocities</span><span class="p">(</span><span class="n">velocs</span><span class="p">)</span>
<span class="n">setVelocity</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

<span class="n">simulation</span><span class="o">.</span><span class="n">reporters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mmapp</span><span class="o">.</span><span class="n">statedatareporter</span><span class="o">.</span><span class="n">StateDataReporter</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">potentialEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kineticEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">remainingTime</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">totalSteps</span> <span class="o">=</span> <span class="n">total_steps</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_steps</span><span class="o">//</span><span class="n">transition_freq</span><span class="p">):</span>
    <span class="n">simulation</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">transition_freq</span><span class="p">)</span>
    <span class="c1"># Change the type of speckles every 4000 steps, non-equilibrium scheme.</span>

    <span class="c1"># Do the chemical modification, and change the spec-spec potential on the fly.</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">start_spec_index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_spec_index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_spec</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">compart_type</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">dP_type</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">compart_type</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_type</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">prob_dP_P</span> <span class="k">else</span> <span class="n">dP_type</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">compart_type</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dP_type</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">prob_P_dP</span> <span class="k">else</span> <span class="n">P_type</span><span class="o">-</span><span class="mi">1</span>

    <span class="c1"># Update the context after changing the type of speckles.</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">chr_system</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">chr_system</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">index_spec_spec_potential</span><span class="p">)</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">compart_type</span><span class="p">[</span><span class="n">m</span><span class="p">]])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">chr_system</span><span class="o">.</span><span class="n">getForce</span><span class="p">(</span><span class="n">index_spec_spec_potential</span><span class="p">)</span><span class="o">.</span><span class="n">updateParametersInContext</span><span class="p">(</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

<span class="c1"># Keep the final result of bead types in case constructing the configuration for the continuous simulation.</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;results/compt_final_frame.txt&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">compart_type</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#&#34;Progress (%)&#34; &#34;Step&#34;  &#34;Potential Energy (kJ/mole)&#34;    &#34;Kinetic Energy (kJ/mole)&#34;      &#34;Temperature (K)&#34;       &#34;Time Remaining&#34;
2.0%    2000    305517.57944424567      239729.9228943532       307.3442102983061       --
4.0%    4000    207185.90673694137      151506.21446981165      194.23757067669288      14:35
6.0%    6000    158288.3406172468       121372.09834880882      155.60432034887066      14:01
8.0%    8000    132847.48986336985      107250.5440399466       137.49987220638914      13:29
10.0%   10000   121596.96969540659      100929.74502448138      129.39633236285206      13:05
12.0%   12000   113962.34265134309      97423.7777640623        124.90152951982073      12:41
14.0%   14000   112257.73056958467      96318.60754455603       123.4846531271768       12:20
16.0%   16000   109864.41145441416      94804.20224058055       121.54311951884611      11:59
18.0%   18000   109899.56832139855      94648.97944137751       121.34411712454603      11:39
20.0%   20000   108446.11521933178      94627.91730774056       121.31711455118477      11:19
22.0%   22000   109445.79017165932      94263.81045584117       120.85031369666426      11:00
24.0%   24000   108907.84712871362      93942.05751382257       120.43781240069778      10:40
26.0%   26000   109715.24762966722      94501.93586251422       121.15560084723053      10:22
28.0%   28000   109012.5285738545       94112.84046071759       120.65676358256171      10:03
30.0%   30000   109207.79834143931      93955.38224187843       120.4548952828525       9:45
32.0%   32000   108795.9361688504       93830.04515171243       120.29420767017125      9:27
34.0%   34000   108592.09765447844      94863.32459109789       121.618916949185        9:09
36.0%   36000   109532.47760620397      93814.96253464038       120.27487109767635      8:51
38.0%   38000   108626.15925753233      95301.87573854289       122.1811586354108       8:34
40.0%   40000   108300.33539516928      94183.20974602466       120.74698007352303      8:17
42.0%   42000   109516.66493095538      93640.43991764485       120.05112549574196      8:00
44.0%   44000   108996.12333174223      93769.1005199753        120.21607399588052      7:42
46.0%   46000   109280.6361911603       93836.14837655456       120.30203227044113      7:25
48.0%   48000   108364.16466056774      93853.77001240787       120.32462397568223      7:08
50.0%   50000   109210.26718781143      94154.07247884736       120.70962482699086      6:51
52.0%   52000   108715.65516172761      94486.79727268191       121.1361925152173       6:35
54.0%   54000   108919.86091815002      94448.96149973289       121.08768540514258      6:18
56.0%   56000   108705.23455818793      94537.86794517544       121.20166734337985      6:01
58.0%   58000   109063.11636587992      93659.14819804284       120.07511032665309      5:44
60.0%   60000   108135.8393093122       94429.40193950695       121.06260919638713      5:28
62.0%   62000   109449.988285381        94249.21790594471       120.83160541164911      5:11
64.0%   64000   108265.71772550428      94931.98987010222       121.7069488297934       4:54
66.0%   66000   108873.47916040457      93522.16191102509       119.89948793585242      4:38
68.0%   68000   108727.68894074738      93940.03245892211       120.435216192049        4:21
70.0%   70000   109450.27407430168      94213.81964361423       120.78622329643153      4:05
72.0%   72000   108723.09269815465      94072.10699834587       120.60454150834501      3:48
74.0%   74000   108844.80312130705      94326.39749392454       120.9305530074787       3:32
76.0%   76000   108184.15437296525      93909.8220192326        120.39648509157962      3:15
78.0%   78000   108687.59792681698      93698.60431995375       120.12569479472339      2:59
80.0%   80000   107990.74859291193      94525.97634042453       121.18642178776784      2:42
82.0%   82000   108185.52120780546      94680.5950308404        121.38464968827138      2:26
84.0%   84000   108176.67632892226      94440.20228596928       121.07645571130833      2:10
86.0%   86000   108495.17923021212      94492.26184807981       121.14319833906276      1:53
88.0%   88000   107678.69027082807      94359.94717841972       120.97356516533716      1:37
90.0%   90000   107893.99383572253      94416.27027058577       121.04577382445795      1:21
92.0%   92000   106406.35815377338      93848.41319502125       120.31775630230409      1:04
94.0%   94000   108033.8972673082       93972.11037766634       120.47634148206463      0:48
96.0%   96000   107101.25632630658      93948.42374930475       120.4459741920721       0:32
98.0%   98000   108023.6646569059       94298.59749964751       120.8949122030926       0:16
100.0%  100000  106862.39324199257      93993.76087071122       120.5040983578318       0:00
</pre></div></div>
</div>
</div>
<div class="section" id="Post-process-the-output-files">
<h2>Post-process the output files<a class="headerlink" href="#Post-process-the-output-files" title="Permalink to this headline">¶</a></h2>
<p>We converted the trajectory with the default OpenMM unit to the nex trajectory with the reduced unit, and saved the final configuration according to the last frame.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coor_transformation</span><span class="p">(</span><span class="s1">&#39;results/step_100000.dcd&#39;</span><span class="p">,</span> <span class="s1">&#39;results/reduced_traj.dcd&#39;</span><span class="p">)</span>
<span class="n">final_frame</span><span class="p">(</span><span class="s1">&#39;results/step_100000.dcd&#39;</span><span class="p">,</span> <span class="s1">&#39;results/compt_final_frame.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;results/final_config.pdb&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ConfigsGeneration.html" class="btn btn-neutral float-left" title="Tutorials: Configuration Generation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ConfigsSelection.html" class="btn btn-neutral float-right" title="Tutorials: Configuration Selection" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Zhuohan Lao.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>